name: Publish

on:
  release:
      types: [published]
  push:
    branches:
      - develop

jobs:
  Publish:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout the repository
      uses: actions/checkout@master
    - name: Determine whether to upload a release version
      run: bash .github/scripts/publish_release_version.bash
    - name: Publish to GHCR (with a tagged image)
      if: ${{ env.PUBLISH_RELEASE_VERSION == 'true' }}
      run: |
        echo ${{ secrets.GHCR_PAT }} | podman login ghcr.io -u ${{ github.actor }} --password-stdin
        podman build --squash-all -t dev .
        podman push dev ghcr.io/paveloom-d/dev:latest
        podman push dev ghcr.io/paveloom-d/dev:${{ env.RELEASE_VERSION }}
    - name: Publish to GHCR (without a tagged image)
      if: ${{ env.PUBLISH_RELEASE_VERSION == 'false' }}
      run: |
        echo ${{ secrets.GHCR_PAT }} | podman login ghcr.io -u ${{ github.actor }} --password-stdin
        podman build --squash-all -t dev .
        podman push dev ghcr.io/paveloom-d/dev:latest
